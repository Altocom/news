<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-apis/google-js-api.html">

<dom-module id="news-credentials">

  <template>
    <google-js-api on-js-api-load="_googleLoad"></google-js-api>
  </template>

  <script>

  (function() {

    var PASSWORD_SIGNIN = 'password';
    var GOOGLE_SIGNIN = 'https://accounts.google.com';
    var FACEBOOK_SIGNIN = 'https://www.facebook.com';
    var SIGNUP = 'signup';

    // handle loading facebook sdk
    var fbLoaded = false;
    var fbLoadCallbacks = [];

    var fbLoadRequestNotify = function(notifyCallback) {
      if (fbLoaded) {
        notifyCallback();
      } else {
        fbLoadCallbacks.push(notifyCallback);
      }
    };

    // get called after facebook sdk is loaded
    window.fbAsyncInit = function() {
      fbLoaded = true;
      fbLoadCallbacks.forEach(function(notifyCallback) {
        notifyCallback();
      });
      fbLoadCallbacks = [];
    }

    Polymer({

      is: 'news-credentials',

      properties: {

        profile: {
          type: Object,
          notify: true
        }

      },

      attached: function() {
        fbLoadRequestNotify(this._fbLoad.bind(this));
      },

      _googleLoad: function() {
        var that = this;
        gapi.load('auth2', function() {
          gapi.auth2.init().then(function() {
            that._googleLoaded = true;
            if (that._fbLoaded) {
              that.fire('credentials-ready');
            }
          })
        });
      },

      _fbLoad: function() {
        FB.init({
          // Replace this with your own App ID
          appId:    FB_APPID,
          cookie:   true,
          xfbml:    false,
          version:  'v2.5'
        });
        this._fbLoaded = true;
        if (this._googleLoaded) {
          this.fire('credentials-ready');
        }
      },

      isSignedIn: function() {
        return this.profile && !!this.profile.id;
      },

      setProfile: function(profile) {
        // Set profile
        this.profile = {
          name:     profile.name,
          id:       profile.id,
          iconURL:  profile.imageUrl,
          email:    profile.email
        };
      },

      resetProfile: function() {
        // reset profile
        this.profile = {
          name:     '',
          id:       '',
          iconURL:  '',
          email:    ''
        };
      },

      autoSignIn: function(unmediated) {
        var that = this;
        // Do nothing when Credential API is not available
        if (navigator.credentials) {
          // Attempt to get credentials and auto-login if possible
          return navigator.credentials.get({
            password: true,
            federated: {
              providers: [GOOGLE_SIGNIN, FACEBOOK_SIGNIN]
            },
            unmediated: unmediated
          }).then(function (cred) {
            // Ensure they're not empty
            if (!cred) {
              return Promise.resolve();
            }

            // TODO: Check creds with the auth backend
            if (cred.type === 'password') {
              return that._authenticateWithServer(PASSWORD_SIGNIN, cred)
            } else if (cred.type === 'federated') {
              switch (cred.provider) {
                case GOOGLE_SIGNIN:
                  // Return Promise from `googleSignIn`
                  return that.googleSignIn(cred.id);
                case FACEBOOK_SIGNIN:
                  // Return Promise from `facebookSignIn`
                  return that.facebookSignIn();
              }
            }
          }).then(function(profile) {
            if (profile) {
              that.setProfile(profile);
            }
            return Promise.resolve(profile);
          }, function() {
            that.resetProfile();
            return Promise.reject();
          });
        } else {
          return Promise.resolve();
        }
      },

      signIn: function(type, cred) {
        switch (type) {
          case 'google':
            return this.googleSignIn();
            break;
          case 'facebook':
              return this.facebookSignIn();
              break;
          case 'password':
            return this.passwordSignIn(cred);
            break;
          default:
            console.log('auth type "' + type + '" not supported!');
        }
      },

      googleSignIn: function(id) {
        var that = this;
        return (function() {
          var auth2 = gapi.auth2.getAuthInstance();
          if (auth2.isSignedIn.get()) {
            var googleUser = auth2.currentUser.get();
            if (googleUser.getBasicProfile().getEmail() === id) {
              return Promise.resolve(googleUser);
            }
          }
          return auth2.signIn({
            login_hint: id || ''
          });
        })().then(function(googleUser) {
          var form = new FormData();
          form.append('id_token', googleUser.getAuthResponse().id_token);
          form.append('csrf_token', Polymer.dom(document).querySelector('#csrf_token').value);
          return that._authenticateWithServer(GOOGLE_SIGNIN, form);
        }).then(function(profile) {
          if (profile) {
            that.setProfile(profile);
            if (navigator.credentials) {
              // Signed in with Google Account
              var cred = new FederatedCredential({
                id:       profile.email,
                name:     profile.name,
                iconURL:  profile.imageUrl,
                provider: GOOGLE_SIGNIN
              });
              navigator.credentials.store(cred);
            }
          }
          return Promise.resolve(profile);
        });
      },

      facebookSignIn: function() {
        var that = this;
        return (function(resolve) {
          return new Promise(function(resolve) {
            FB.getLoginStatus(function(res) {
              if (res.status == 'connected') {
                resolve(res);
              } else {
                FB.login(resolve, {scope: 'email'});
              }
            });
          });
        })().then(function(res) {
          // On successful authentication with Facebook
          if (res.status == 'connected') {
            var form = new FormData();
            // For Facebook, we use the Access Token to authenticate.
            form.append('access_token', res.authResponse.accessToken);
            // Don't forget to include the CSRF Token.
            form.append('csrf_token', document.querySelector('#csrf_token').value);
            return that._authenticateWithServer(FACEBOOK_SIGNIN, form);
          } else {
            // When authentication was rejected by Facebook
            return Promise.reject();
          }
        }).then(function(profile) {
          if (profile) {
            that.setProfile(profile);
            if (navigator.credentials) {
              // Create `Credential` object for federation
              var cred = new FederatedCredential({
                id:       profile.email,
                name:     profile.name,
                iconURL:  profile.imageUrl || DEFAULT_IMG,
                provider: FACEBOOK_SIGNIN
              });
              // Store credential information after successful authentication
              navigator.credentials.store(cred);
            }
          }
          return Promise.resolve(profile);
        });
      },

      passwordSignIn: function(form) {
        var that = this;
        return this._authenticateWithServer(PASSWORD_SIGNIN, form).then(function(profile) {
          that.setProfile(profile);
          if (navigator.credentials) {
            var email = form.get('email');
            var password = form.get('password');
            var cred = new PasswordCredential({
              id:       email,
              password: password
            });
            // Credential stored
            return navigator.credentials.store(cred);
         }
       });
      },

      passwordSignUp: function(form) {
        var that = this;
        return this._authenticateWithServer(SIGNUP, form).then(function(profile) {
          that.setProfile(profile);
          if (navigator.credentials) {
            var email = form.get('email');
            var password = form.get('password');
            var cred = new PasswordCredential({
              id:       email,
              password: password
            });
            // Credential stored
            return navigator.credentials.store(cred);
          }
        });
      },

      _authenticateWithServer: function(type, cred) {
        var opt, path;
        // Attempting sign in with Server
        switch (type) {
          case GOOGLE_SIGNIN:
            path = '/auth/google';
            break;
          case FACEBOOK_SIGNIN:
              path = '/auth/facebook';
              break;
          case SIGNUP:
            path = '/register';
            break;
          default:
            path = '/auth/password';
            break;
        }

        var csrf_token = Polymer.dom(document).querySelector('#csrf_token').value;
        if (cred instanceof FormData) {
          cred.append('csrf_token', csrf_token);
          opt = {
            method: 'POST',
            credentials: 'include',
            body: cred
          }
        } else {
          cred.additionalData = new FormData();
          cred.additionalData.append('csrf_token', csrf_token);
          cred.idName = 'email';
          opt = {
            method: 'POST',
            credentials: cred
          }
        }

        return fetch(path, opt).then(function(res) {
          if (res.status === 200) {
            // Server authentication succeeded
            return res.json();
          } else {
            // Server authentication failed
            return Promise.reject('Authentication failed');
          }
        });
      },

      signOut: function() {
        if (navigator.credentials) {
          navigator.credentials.requireUserMediation();
        }
        this.resetProfile();
        return Promise.resolve();
      }

    });

  })();

  // load the facebook sdk
  (function(d, s, id){
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  </script>

</dom-module>
